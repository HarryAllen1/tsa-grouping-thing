rules_version = '2';

// Craft rules based on data in your Firestore database
// allow write: if firestore.get(
//    /databases/(default)/documents/users/$(request.auth.uid)).data.isAdmin;
service firebase.storage {
  match /b/{bucket}/o {
    // Helper function to check if user is admin
    function isAdmin() {
      return firestore.get(/databases/(default)/documents/users/$(request.auth.token.email)).data.admin == true;
    }
    
    // Helper function to check if user is a member of a specific team in an event
    function isTeamMember(eventName, teamId) {
      let eventDoc = firestore.get(/databases/(default)/documents/events/$(eventName)).data;
      let userEmail = request.auth.token.email;
      
      return eventDoc.teams.hasAny([teamId]) &&
             eventDoc.teams[teamId].members.hasAny([userEmail]);
    }
    
    match /results/{teamId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /files/{event}/{teamId} {
    	allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // Secure submissions path - only team members can write, everyone can read
    match /submissions/{eventName}/{teamId}/{fileName} {
      allow read: if request.auth != null;
      // Users can only upload to their own team's folder
      // Deletion is handled by Cloud Function for proper validation
      allow create: if request.auth != null && 
                      request.resource.size <= 250 * 1024 * 1024 && // 250MB limit
                      request.resource.metadata.customMetadata.keys().hasAll(['teamId', 'userEmail', 'userName']) &&
                      request.resource.metadata.customMetadata.teamId == teamId &&
                      request.resource.metadata.customMetadata.userEmail == request.auth.token.email;
      // Prevent direct deletion - must use Cloud Function
      allow delete: if false;
      allow update: if false;
    }
    
    // Default deny for all other paths
    match /{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if false;
    }
  }
}
