rules_version = '2';

// Craft rules based on data in your Firestore database
// allow write: if firestore.get(
//    /databases/(default)/documents/users/$(request.auth.uid)).data.isAdmin;
service firebase.storage {
  match /b/{bucket}/o {
    // Helper function to check if user is admin
    function isAdmin() {
      return firestore.get(/databases/(default)/documents/users/$(request.auth.token.email)).data.admin == true;
    }
    
    match /results/{teamId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /files/{event}/{teamId} {
    	allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // Secure submissions path - only team members can write, everyone can read
    match /submissions/{eventName}/{teamId}/{fileName} {
      allow read: if request.auth != null;
      // Users can only upload to their own team's folder
      // Team membership is validated via metadata that must match the authenticated user
      allow create: if request.auth != null && 
                      request.resource.size <= 250 * 1024 * 1024 && // 250MB limit
                      request.resource.metadata.customMetadata.keys().hasAll(['teamId', 'userEmail', 'userName']) &&
                      request.resource.metadata.customMetadata.teamId == teamId &&
                      request.resource.metadata.customMetadata.userEmail == request.auth.token.email;
      // Admins can delete directly, team members must use Cloud Function for validation
      allow delete: if isAdmin();
      allow update: if false;
    }
    
    // Default deny for all other paths (read-only for authenticated users)
    match /{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if false;
    }
  }
}
